#!/usr/bin/perl -w
#
# qpeek:  Peek into a job's output spool files
# Copyright 2006, 2007 Ohio Supercomputer Center
# Revision info:
# $HeadURL$
# $Revision$
# $Date$
#
# Usage:  qpeek [options] JOBID
#
# Options:
#   -c      Show all of the output file ("cat", default)
#   -h      Show only the beginning of the output file ("head")
#   -t      Show only the end of the output file ("tail")
#   -f      Show only the end of the file and keep listening ("tail -f")
#   -#      Show only # lines of output
#   -e      Show the stderr file of the job
#   -o      Show the stdout file of the job
#   -?      Display help
use strict;
use warnings;
use Getopt::Std;
use PBS qw/pbs_connect pbs_statjob pbs_default pbs_disconnect/;

my %options;
getopt('a', \%options);

my $tool="cat";
my $numlines="";
my $suffix="OU";
my $spooldir;
#~ my $pbsserver;
my $mothersuperior;

sub mothersuperior {
	my $execution_hosts;
	my $con=pbs_connect(pbs_default());
	my $status=pbs_statjob($con, $ARGV[0],undef, undef);
	my @attribs = @{$status->[0]{attribs}};  # we only get 1 status value back
	foreach my $hash_ref (@attribs) {
		$execution_hosts = $hash_ref->{value} if($hash_ref->{name} eq "exec_host");
	}
	$mothersuperior = (split(/\//, $execution_hosts))[0];
}

if (defined($ENV{"PBS_HOME"})) {
	$spooldir=$ENV{"PBS_HOME"};
} else {
	my @defaults=("/usr/spool/PBS",
		"/var/spool/pbs",
		"/var/torque",
		"/var/spool/torque",
		"/var/spool/batch/pbs",
		"/var/spool/batch/torque",
		"/var/spool/batch/pbs-piv",
		"/var/spool/batch/pbs-ipf",
		#~ ".",
		);
	foreach my $dir ( @defaults ) {
		if ( -d $dir ) {
			$spooldir=$dir;
			last;
		}
	}
}
die "Unable to find PBS spool directory!\n" if ( !defined($spooldir) );

#~ $pbsserver=`cat $spool/server_name` || 
open(SERVERFH, '<', "$spooldir/server_name");
chomp(my $pbsserver = <SERVERFH>);
#~ while (<SERVERFH>) {chomp (my $pbsserver=$_)} or die "Unable to find PBS server name!\n";

sub usage {
	print STDOUT <<EOF;
qpeek:  Peek into a job's output spool files

 Usage:  qpeek [options] JOBID

 Options:
   -c      Show all of the output file ("cat", default)
   -h      Show only the beginning of the output file ("head")
   -t      Show only the end of the output file ("tail")
   -f      Show only the end of the file and keep listening ("tail -f")
   -<num>f Show only the last <num> lines and keep listening ("tail -<num>f")
   +0f     Show all of the file and keep listening ("tail +0f")
   -#      Show only # lines of output ("tail -<num>")
   -e      Show the stderr file of the job
   -o      Show the stdout file of the job (default)
   -?      Display this help message
EOF
}

$tool="cat" if ($options{c});
$tool="head" if ($options{h});
$tool="tail" if ($options{t});
$numlines=$options{f};
$suffix="OU" if ($options{o});
$suffix="ER" if ($options{e});
my $jobid=$ARGV;

my $node=&mothersuperior($jobid);
die "Job $jobid is not running!\n" if ( $node eq "" );

my $jobname = "$jobid.$pbsserver";
# chop to magic pbs length
#~ $jobname =~ s/(.{11}).*/$1/;

my $command="ssh -n $node $tool $numlines $spooldir/spool/$jobname.$suffix";
print "running $command\n";
exec $command;
